import React, { useState, useEffect, useRef } from 'react';

export default function EnhancedTicketCard({
  t,
  onAction,
  onUpdate,
  onDelete,
  users = [],
  apiBase = '/api/tickets'
}) {
  const [openView, setOpenView] = useState(false);
  const [editing, setEditing] = useState(false);
  const [local, setLocal] = useState({ ...t });
  const [loading, setLoading] = useState(false);
  const [confirmDelete, setConfirmDelete] = useState(false);
  const [toast, setToast] = useState(null);
  const [showPriorityMenu, setShowPriorityMenu] = useState(false);
  const [showStatusMenu, setShowStatusMenu] = useState(false);
  const priorityRef = useRef();
  const statusRef = useRef();

  useEffect(() => {
    setLocal({ ...t });
  }, [t]);

  useEffect(() => {
    if (!toast) return;
    const id = setTimeout(() => setToast(null), 3000);
    return () => clearTimeout(id);
  }, [toast]);

  const priorityStyles = {
    Low: 'bg-green-100 text-green-800',
    Medium: 'bg-yellow-100 text-yellow-800',
    High: 'bg-red-100 text-red-800'
  };

  async function saveChanges() {
    setLoading(true);
    try {
      const payload = { title: local.title, description: local.description, priority: local.priority, status: local.status, assignee: local.assignee };
      if (onUpdate) {
        await onUpdate(local._id, payload);
      } else {
        await fetch(`${apiBase}/${local._id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      }
      setEditing(false);
      setToast('Saved');
    } catch (e) {
      console.error(e);
      setToast('Failed to save');
    } finally {
      setLoading(false);
    }
  }

  async function handleAction(name) {
    if (onAction) return onAction(name, local);
    setLoading(true);
    try {
      await fetch(`${apiBase}/${local._id}/actions`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: name })
      });
      setToast('Action sent');
    } catch (e) {
      console.error(e);
      setToast('Action failed');
    } finally {
      setLoading(false);
    }
  }

  async function handleDelete() {
    setLoading(true);
    try {
      if (onDelete) await onDelete(local._id);
      else await fetch(`${apiBase}/${local._id}`, { method: 'DELETE' });
      setToast('Deleted');
    } catch (e) {
      console.error(e);
      setToast('Delete failed');
    } finally {
      setLoading(false);
      setConfirmDelete(false);
    }
  }

  function startEdit() {
    setEditing(true);
    setShowPriorityMenu(false);
    setShowStatusMenu(false);
  }

  function cancelEdit() {
    setLocal({ ...t });
    setEditing(false);
  }

  function openInNewTab() {
    if (typeof window !== 'undefined') window.open(`${apiBase}/${local._id}`, '_blank');
  }

  return (
    <article className="bg-white p-4 rounded-lg shadow hover:shadow-md transition-shadow w-full">
      <div className="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div className="flex-1 w-full">
          {editing ? (
            <input
              value={local.title}
              onChange={(e) => setLocal(s => ({ ...s, title: e.target.value }))}
              className="w-full text-lg font-semibold text-slate-800 border border-slate-200 rounded px-2 py-1 focus:outline-none focus:ring"
              aria-label="Edit title"
            />
          ) : (
            <h3 className="text-lg font-semibold text-slate-800">{local.title}</h3>
          )}

          {editing ? (
            <textarea
              value={local.description}
              onChange={(e) => setLocal(s => ({ ...s, description: e.target.value }))}
              className="mt-2 text-sm text-slate-700 w-full border rounded p-2 h-20 resize-y focus:outline-none focus:ring"
              aria-label="Edit description"
            />
          ) : (
            <p className="text-sm text-slate-600 mt-1 max-h-16 overflow-hidden">{local.description}</p>
          )}

          <div className="mt-3 text-xs text-slate-500">Created: {new Date(local.createdAt).toLocaleString()}</div>

          <div className="mt-2 flex flex-wrap gap-2">
            <div className={`inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs font-semibold ${priorityStyles[local.priority] || priorityStyles.Low}`}>
              {local.priority}
            </div>

            <div className="text-xs font-medium text-slate-700 px-2 py-1 rounded border">{local.status}</div>

            {local.assignee && (
              <div className="text-xs text-slate-700 px-2 py-1 rounded border">Assigned to: {local.assignee.name || local.assignee}</div>
            )}

            {local.dueDate && (
              <div className="text-xs text-slate-700 px-2 py-1 rounded border">Due: {new Date(local.dueDate).toLocaleDateString()}</div>
            )}
          </div>
        </div>

        <div className="flex flex-col items-end gap-2">
          <div className="flex items-center gap-2">
            <div className="relative">
              <button
                ref={priorityRef}
                onClick={() => setShowPriorityMenu(s => !s)}
                className={`px-3 py-1 rounded text-sm font-semibold ${priorityStyles[local.priority] || priorityStyles.Low} focus:outline-none`}
                aria-haspopup="true"
                aria-expanded={showPriorityMenu}
              >
                {local.priority}
              </button>

              {showPriorityMenu && (
                <ul className="absolute right-0 mt-2 w-40 bg-white border rounded shadow p-1 z-20">
                  {['Low', 'Medium', 'High'].map(p => (
                    <li key={p}>
                      <button
                        className="w-full text-left px-3 py-1 text-sm rounded hover:bg-slate-50"
                        onClick={() => { setLocal(s => ({ ...s, priority: p })); setShowPriorityMenu(false); }}
                      >
                        {p}
                      </button>
                    </li>
                  ))}
                </ul>
              )}
            </div>

            <div className="relative">
              <button
                ref={statusRef}
                onClick={() => setShowStatusMenu(s => !s)}
                className="px-3 py-1 rounded text-sm font-medium border focus:outline-none"
                aria-haspopup="true"
                aria-expanded={showStatusMenu}
              >
                {local.status}
              </button>

              {showStatusMenu && (
                <ul className="absolute right-0 mt-2 w-48 bg-white border rounded shadow p-1 z-20">
                  {['Open', 'In Progress', 'On Hold', 'Resolved', 'Closed'].map(s => (
                    <li key={s}>
                      <button
                        className="w-full text-left px-3 py-1 text-sm rounded hover:bg-slate-50"
                        onClick={() => { setLocal(st => ({ ...st, status: s })); setShowStatusMenu(false); }}
                      >
                        {s}
                      </button>
                    </li>
                  ))}
                </ul>
              )}
            </div>
          </div>

          <div className="flex gap-2">
            {!editing && <button onClick={startEdit} className="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700">Edit</button>}
            {editing && (
              <>
                <button onClick={saveChanges} disabled={loading} className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700">{loading ? 'Saving...' : 'Save'}</button>
                <button onClick={cancelEdit} className="px-3 py-1 bg-slate-100 text-slate-700 rounded">Cancel</button>
              </>
            )}

            <button onClick={() => handleAction('request')} className="px-3 py-1 bg-indigo-50 text-indigo-700 rounded">Request Info</button>
            <button onClick={() => handleAction('resolve')} className="px-3 py-1 bg-green-50 text-green-700 rounded">Mark Resolved</button>

            <button onClick={openInNewTab} className="px-3 py-1 bg-slate-100 text-slate-700 rounded">Open</button>

            <button onClick={() => setOpenView(true)} className="px-3 py-1 bg-slate-50 text-slate-800 rounded">View</button>

            <button onClick={() => setConfirmDelete(true)} className="px-3 py-1 bg-red-50 text-red-700 rounded">Delete</button>
          </div>
        </div>
      </div>

      {openView && (
        <Modal onClose={() => setOpenView(false)}>
          <div className="p-4">
            <h2 className="text-xl font-semibold">{local.title}</h2>
            <div className="mt-2 text-sm text-slate-700">{local.description}</div>

            <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div className="space-y-2">
                <div className="text-xs text-slate-500">Priority</div>
                <div className={`inline-flex items-center gap-2 px-2 py-1 rounded-full text-sm font-semibold ${priorityStyles[local.priority] || priorityStyles.Low}`}>{local.priority}</div>

                <div className="text-xs text-slate-500 mt-2">Status</div>
                <div className="text-sm font-medium">{local.status}</div>

                <div className="text-xs text-slate-500 mt-2">Assignee</div>
                <div className="text-sm">{local.assignee?.name || local.assignee || 'Unassigned'}</div>

                <div className="text-xs text-slate-500 mt-2">Created</div>
                <div className="text-sm">{new Date(local.createdAt).toLocaleString()}</div>
              </div>

              <div className="space-y-2">
                <div className="text-xs text-slate-500">Attachments</div>
                {local.attachments?.length ? (
                  <ul className="space-y-1">
                    {local.attachments.map((a, i) => (
                      <li key={i}><a href={a.url} target="_blank" rel="noreferrer" className="text-indigo-600 underline">{a.name || `Attachment ${i+1}`}</a></li>
                    ))}
                  </ul>
                ) : (
                  <div className="text-sm text-slate-500">No attachments</div>
                )}

                <div className="text-xs text-slate-500 mt-2">Comments</div>
                {local.comments?.length ? (
                  <div className="max-h-40 overflow-auto border rounded p-2 bg-slate-50">
                    {local.comments.map((c, i) => (
                      <div key={i} className="text-sm py-1 border-b last:border-none"> <strong className="text-slate-700">{c.author}</strong>: {c.text}</div>
                    ))}
                  </div>
                ) : (
                  <div className="text-sm text-slate-500">No comments</div>
                )}
              </div>
            </div>

            <div className="mt-4 flex gap-2 justify-end">
              <button onClick={() => setOpenView(false)} className="px-3 py-1 bg-slate-100 rounded">Close</button>
            </div>
          </div>
        </Modal>
      )}

      {confirmDelete && (
        <Modal onClose={() => setConfirmDelete(false)}>
          <div className="p-4">
            <h3 className="text-lg font-semibold">Confirm delete</h3>
            <p className="text-sm text-slate-600 mt-2">Are you sure you want to delete this ticket? This action cannot be undone.</p>
            <div className="mt-4 flex gap-2 justify-end">
              <button onClick={() => setConfirmDelete(false)} className="px-3 py-1 bg-slate-100 rounded">Cancel</button>
              <button onClick={handleDelete} disabled={loading} className="px-3 py-1 bg-red-600 text-white rounded">{loading ? 'Deleting...' : 'Delete'}</button>
            </div>
          </div>
        </Modal>
      )}

      {toast && (
        <div className="fixed bottom-4 right-4 bg-black text-white px-4 py-2 rounded shadow">{toast}</div>
      )}
    </article>
  );
}

function Modal({ children, onClose }) {
  useEffect(() => {
    function onKey(e) { if (e.key === 'Escape') onClose(); }
    document.addEventListener('keydown', onKey);
    return () => document.removeEventListener('keydown', onKey);
  }, [onClose]);

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
      <div className="absolute inset-0 bg-black/40" onClick={onClose} />
      <div className="relative bg-white rounded shadow-lg w-full max-w-3xl overflow-auto">{children}</div>
    </div>
  );
}
